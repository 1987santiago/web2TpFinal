<?php
    session_start();
<<<<<<< HEAD
    // guardamos la nueva ruta base del site
    $local_path = $_SESSION["local_path"];
    // se guarda la ruta para ejecutar php
    $http_path = $_SESSION["http_path"];
    
    require_once $local_path . "/components/database.php";
=======
    require_once 'database.php';
>>>>>>> a53980cc692633ef8dbabd31edbcabc735fdfb83
    define("EXCEDENTE", 10); // constante
        
    function getAsientosLibres($vuelo, $categoria) 
    {
        $asientosLibres = 0;
        $skynet = new Database();
        $conexionCorrecta = $skynet->connect();
        if ($conexionCorrecta) 
        {
            switch ($categoria) 
            {
                case 100:   // primera
                            $asientosCategoria = "SELECT asientos_primera as asientos
                                                  FROM avion
                                                  WHERE codigo_avion =  (SELECT codigo_avion  
                                                                         FROM vuelo 
                                                                         WHERE numero_vuelo = $vuelo)";
                            break;   
                case 200:   // economy
                            $asientosCategoria = "SELECT asientos_economy as asientos
                                                  FROM avion
                                                  WHERE codigo_avion =  (SELECT codigo_avion  
                                                                         FROM vuelo 
                                                                         WHERE numero_vuelo = $vuelo)";
                            break;
            }
            $asientos = $skynet->executeSelect($asientosCategoria);
            $totalAsientos = intval($asientos[0]["asientos"]);
            $reservasHechas = "SELECT count(*) as reservas
                               FROM reserva
                               WHERE numero_vuelo = $vuelo and id_categoria = $categoria and esta_en_espera = false";
            $reservas = $skynet->executeSelect($reservasHechas);
            $totalReservas = intval($reservas[0]["reservas"]);
            if ($totalAsientos > 0) 
            {
                $asientosLibres = $totalAsientos - $totalReservas;
            }
            $skynet->disconnect();
        }
        return $asientosLibres;
    }
    
    function getReservasEnEspera($vuelo) 
    {
        $skynet = new Database();
        $conexionCorrecta = $skynet->connect();
        $totalReservasEnEspera = 0;
        if ($conexionCorrecta) 
        {
            $query = "SELECT count(*) as reservas
                      FROM reserva
                      WHERE numero_vuelo = $vuelo and esta_en_espera = true";
            $reservasEnEspera = $skynet->executeSelect($query);
            $totalReservasEnEspera = intval($reservasEnEspera[0]["reservas"]);
            $skynet->disconnect();
        }
        return $totalReservasEnEspera;
    }
    
    $tipoDeViaje=$_SESSION["tipoDeViaje"];
    switch ($tipoDeViaje) 
    {
        case 1: 
                // viaje ida
                $categoria = (int) $_POST["categoria"];
                $vuelo = (int) $_POST["vuelo"];
                $_SESSION["categoriaIdaElegida"] = $categoria;
                $_SESSION["vueloIdaElegido"] = $vuelo;
                $asientosLibresIda = getAsientosLibres($vuelo, $categoria);
                $reservasEsperaIda = getReservasEnEspera($vuelo);
                $reservaIdaPermitida = false;
                if ($asientosLibresIda > 0)
                {
                    $reservaIdaEnEspera = false;
                    $reservaIdaPermitida = true;
                }
                else
                {
                    if ($reservasEsperaIda < EXCEDENTE) 
                    {
                        $reservaIdaEnEspera = true; 
                        $reservaIdaPermitida = true;
                    }
                }
                if ($reservaIdaPermitida) 
                {
<<<<<<< HEAD
                    $siguiente = $http_path . "/components/datos_pasajero.php";
                    $_SESSION["reservaIdaEnEspera"] = $reservaIdaEnEspera;
                    header("Location: " . $siguiente);
=======
                    header("Location: datos_pasajero.php");
                    $_SESSION["reservaIdaEnEspera"] = $reservaIdaEnEspera;
>>>>>>> a53980cc692633ef8dbabd31edbcabc735fdfb83
                }
                else
                {    
                    $errorNoHayAsientos = "No hay asientos para el vuelo de ida entre " . $_SESSION["ciudadOrigen"] . 
                                          " y " . $_SESSION["ciudadDestino"] . " en la categoria " . $_SESSION["categoriaIdaElegida"];
<<<<<<< HEAD
                    $error = $http_path . "/components/error.php";
                    $anterior = $http_path . "/components/listado_vuelos_ida.php";
                    header("Location: " . $error . "?mensaje=$errorNoHayAsientos&anterior=$anterior");
=======
                    $anterior = "listado_vuelos_ida.php";
                    header("Location: error.php?mensaje=$errorNoHayAsientos&anterior=$anterior");
>>>>>>> a53980cc692633ef8dbabd31edbcabc735fdfb83
                }
                break;
        case 2: 
                // viaje ida y vuelta
                // vuelo ida
                $categoria = (int) $_POST["categoria"];
                $vuelo = (int) $_POST["vuelo"];
                $_SESSION["categoriaIdaElegida"] = $categoria;
                $_SESSION["vueloIdaElegido"] = $vuelo;
                $asientosLibresIda = getAsientosLibres($vuelo, $categoria);
                $reservasEsperaIda = getReservasEnEspera($vuelo);
                $reservaIdaPermitida = false;
                if ($asientosLibresIda > 0)
                {
                    $reservaIdaEnEspera = false;
                    $reservaIdaPermitida = true;
                }
                else
                {
                    if ($reservasEsperaIda < EXCEDENTE) 
                    {
                        $reservaIdaEnEspera = true;
                        $reservaIdaPermitida = true;
                    }
                }
                // vuelo regreso
                $categoriaRegreso = (int) $_POST["categoriaRegreso"];
                $vueloRegreso = (int) $_POST["vueloRegreso"];
                $_SESSION["categoriaRegresoElegida"] = $categoriaRegreso;
                $_SESSION["vueloRegresoElegido"] = $vueloRegreso;
                $asientosLibresRegreso = getAsientosLibres($vueloRegreso, $categoriaRegreso);
                $reservasEsperaRegreso = getReservasEnEspera($vueloRegreso);
                $reservaRegresoPermitida = false;
                if ($asientosLibresRegreso > 0)
                {
                    $reservaRegresoEnEspera = false;
                    $reservaRegresoPermitida = true;
                }
                else
                {
                    if ($reservasEsperaRegreso < EXCEDENTE) 
                    {
                        $reservaRegresoEnEspera = true;
                        $reservaRegresoPermitida = true;
                    }
                }
                if ($reservaIdaPermitida && $reservaRegresoPermitida) 
                {
<<<<<<< HEAD
                    $_SESSION["reservaIdaEnEspera"] = $reservaIdaEnEspera;
                    $_SESSION["reservaRegresoEnEspera"] = $reservaRegresoEnEspera;
                    $siguiente = $http_path . "/components/datos_pasajero.php";
                    header("Location: ". $siguiente);
=======
                    header("Location: datos_pasajero.php");
                    $_SESSION["reservaIdaEnEspera"] = $reservaIdaEnEspera;
                    $_SESSION["reservaRegresoEnEspera"] = $reservaRegresoEnEspera;
>>>>>>> a53980cc692633ef8dbabd31edbcabc735fdfb83
                }
                else
                {    
                    if (!$reservaIdaPermitida) 
                    {
                        $errorNoHayAsientos = "No hay asientos para el vuelo de ida entre " . $_SESSION["ciudadOrigen"] . 
                                              " y " . $_SESSION["ciudadDestino"] . " en la categoria " . $_SESSION["categoriaIdaElegida"];
<<<<<<< HEAD
                        $error = $http_path . "/components/error.php";
                        $anterior = $http_path . "/components/listado_vuelos_ida_regreso.php";
                        header("Location: " . $error . "?mensaje=$errorNoHayAsientos&anterior=$anterior");
=======
                        $anterior = "listado_vuelos_ida_regreso.php";
                        header("Location: error.php?mensaje=$errorNoHayAsientos&anterior=$anterior");
>>>>>>> a53980cc692633ef8dbabd31edbcabc735fdfb83
                        die();
                    }
                    if (!$reservaRegresoPermitida) 
                    {
                        $errorNoHayAsientosRegreso = "No hay asientos para el vuelo de regreso entre " . $_SESSION["ciudadDestino"] . 
                                                     " y " . $_SESSION["ciudadOrigen"] . " en la categoria " . $_SESSION["categoriaRegresoElegida"];
<<<<<<< HEAD
                        $error = $http_path . "/components/error.php";
                        $anterior = $http_path . "/components/listado_vuelos_ida_regreso.php";
                        header("Location: " . $error . "?mensaje=$errorNoHayAsientosRegreso&anterior=$anterior");
=======
                        $anterior = "listado_vuelos_ida_regreso.php";
                        header("Location: error.php?mensaje=$errorNoHayAsientosRegreso&anterior=$anterior");
>>>>>>> a53980cc692633ef8dbabd31edbcabc735fdfb83
                        die();
                    }
                } 
                break;    
    }
?>
